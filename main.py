import os
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    MessageHandler,
    filters,
    ContextTypes,
    CallbackContext,
    CommandHandler,
    Defaults
)
from chatbot import SefariaChatBot

class TelegramSefariaChatBot(SefariaChatBot):
    def __init__(self):
        super().__init__()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        self.system_prompt = """
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –µ–≤—Ä–µ–π—Å–∫–∏–º —Ç–µ–∫—Å—Ç–∞–º –∏ —Ç—Ä–∞–¥–∏—Ü–∏—è–º. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

1. –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ü–∏—Ç–∞—Ç –≤ —Å–∫–æ–±–∫–∞—Ö (–ø—Ä–∏–º–µ—Ä: –ë–µ—Ä–µ—à–∏—Ç 1:1, –ú–∏—à–Ω–∞ –°–∞–Ω–≥–µ–¥—Ä–∏–Ω 4:5)
- –î–ª—è –º—É–¥—Ä–µ—Ü–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä–æ–≤ —É–∫–∞–∑—ã–≤–∞–π –ø–µ—Ä–∏–æ–¥ –∏ —Ä–µ–≥–∏–æ–Ω (–ø—Ä–∏–º–µ—Ä: –†–∞—à–∏ (–§—Ä–∞–Ω—Ü–∏—è, XI –≤–µ–∫))

2. –û–±—ä—è—Å–Ω–µ–Ω–∏—è:
- –î–ª—è –≤—Å–µ—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤ –¥–∞–≤–∞–π –∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ –≤ —Å–∫–æ–±–∫–∞—Ö
- –°–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –æ–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º, –Ω–æ –±–µ–∑ —É–ø—Ä–æ—â–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
- –ü—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü –¥–æ–±–∞–≤–ª—è–π –∫—Ä–∞—Ç–∫—É—é —Å–ø—Ä–∞–≤–∫—É

3. –£—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏:
- –û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã —Å–≤–µ—Ç—Å–∫–æ–º—É —á–∏—Ç–∞—Ç–µ–ª—é –±–µ–∑ —Ä–µ–ª–∏–≥–∏–æ–∑–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- –ò–∑–±–µ–≥–∞–π –∏–∑–±—ã—Ç–æ—á–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–æ –Ω–µ —É–ø—Ä–æ—â–∞–π –¥–æ —É—Ä–æ–≤–Ω—è –∫–ª–∏—à–µ
- –ò–∑–±–µ–≥–∞–π –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π —Ç–æ—á–Ω–æ—Å—Ç—å
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–Ω—è—Ç–∏–π

4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–π —É—Ç–æ—á–Ω–µ–Ω–∏—è
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä—è–º–æ —É–∫–∞–∑—ã–≤–∞–π –Ω–∞ —ç—Ç–æ
- –†–∞–∑–¥–µ–ª—è–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏

5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞ —Å –ø–æ–º–æ—â—å—é HTML
- –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏—Ä–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (<b>–ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ —Ç–µ—Ä–º–∏–Ω–∞–º</b>, <b>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Å–ø—Ä–∞–≤–∫–∏</b>)
- –î–æ–±–∞–≤–ª—è–π –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ü–µ

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
[–û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç]
[–ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ —Ç–µ—Ä–º–∏–Ω–∞–º]
[–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Å–ø—Ä–∞–≤–∫–∏]

–ü—Ä–∏–º–µ—Ä:
–¢–∏–∫–∫—É–Ω –æ–ª–∞–º (–±—É–∫–≤. "–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏—Ä–∞") ‚Äî —ç—Ç–æ –∫–æ–Ω—Ü–µ–ø—Ü–∏—è...

<b>–ü–æ—è—Å–Ω–µ–Ω–∏—è –∫ —Ç–µ—Ä–º–∏–Ω–∞–º:</b>
- –¢–∏–∫–∫—É–Ω –æ–ª–∞–º: –∏–¥–µ—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ —É—á–∞—Å—Ç–∏—è –≤ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ –º–∏—Ä–∞
- –¶–¥—É–∫–∞: –µ–≤—Ä–µ–π—Å–∫–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è –±–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

<b>–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Å–ø—Ä–∞–≤–∫–∏:</b>
- –£–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –≤ –ú–∏—à–Ω–µ (–ì–∏—Ç–∏–Ω 4:5)
- –†–∞–∑–≤–∏—Ç–∞ –ª—É—Ä–∏–∞–Ω—Å–∫–æ–π –∫–∞–±–±–∞–ª–æ–π (–ò—Å–∞–∞–∫ –õ—É—Ä–∏—è, –¶—Ñ–∞—Ç, XVI –≤–µ–∫)

<blockquote>‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏–≤–µ–¥–µ–Ω–∞ –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –º–Ω–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —Ä–∞–≤–≤–∏–Ω–æ–º.</blockquote>
        """
    
    def process_query(self, user_input):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        return super().process_query(user_input)

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∫–µ–Ω–∞
load_dotenv()
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

if not TELEGRAM_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
chat_bot = TelegramSefariaChatBot()

async def send_welcome(update: Update):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    welcome_msg = """
üìñ <b>–®–∞–ª–æ–º!</b> –Ø –≤–∞—à —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –µ–≤—Ä–µ–π—Å–∫–∏–º —Ç–µ–∫—Å—Ç–∞–º –∏ —Ç—Ä–∞–¥–∏—Ü–∏—è–º.

–ú–æ–≥—É –ø–æ–º–æ—á—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ:
- –¢–æ—Ä–µ, –¢–∞–ª–º—É–¥–µ –∏ –ö–∞–±–±–∞–ª–µ
- –ï–≤—Ä–µ–π—Å–∫–∏—Ö –∑–∞–∫–æ–Ω–∞—Ö (–≥–∞–ª–∞—Ö–∞) –∏ –æ–±—ã—á–∞—è—Ö
- –ó–Ω–∞—á–µ–Ω–∏–∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤ –∏ –∑–∞–ø–æ–≤–µ–¥–µ–π
- –ü–µ—Ä–µ–≤–æ–¥–µ –∏ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤

–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –∏ —è –¥–∞–º —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

<blockquote>‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –î–ª—è –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –ø–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–≤–≤–∏–Ω—É.</blockquote>
"""
    await update.message.reply_text(welcome_msg, parse_mode="HTML")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
    if user_input := update.message.text:
        response = chat_bot.process_query(user_input)
        await update.message.reply_text(response, parse_mode="HTML")

async def start(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    await send_welcome(update)

def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    app = ApplicationBuilder() \
        .token(TELEGRAM_TOKEN) \
        .defaults(Defaults(parse_mode="HTML")) \
        .build()

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    app.run_polling()

if __name__ == "__main__": 
    main()