# Shuva Telegram Bot

Телеграм-бот, который использует API OpenRouter для генерации ответов и API Sefaria для получения знаний о еврейских текстах и традициях.

## Описание

Этот проект представляет собой телеграм-бота, который объединяет возможности языковых моделей через OpenRouter API с обширной базой еврейских текстов Sefaria. Пользователи могут задавать вопросы о еврейских текстах, традициях и концепциях, а бот будет искать релевантную информацию в Sefaria и использовать ее для формирования ответов с помощью языковой модели.

## Особенности

- Интеграция с OpenRouter API для доступа к различным языковым моделям
- Поиск и извлечение релевантных текстов из Sefaria API
- Форматирование и отображение цитат из еврейских текстов с использованием HTML-разметки
- Простой и надежный код без избыточной функциональности
- Быстрый запуск и минимальное использование ресурсов

## Требования

- Python 3.7+
- python-telegram-bot >= 20.0
- Requests
- python-dotenv

## Установка

1. Клонируйте репозиторий:
   ```
   git clone https://github.com/yourusername/shuva-tgbot.git
   cd shuva-tgbot
   ```

2. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```

3. Создайте файл `.env` на основе `.env.example` и добавьте свои API ключи:
   ```
   cp .env.example .env
   ```
   Затем отредактируйте файл `.env` и добавьте свои ключи:
   ```
   OPENROUTER_API_KEY=your_openrouter_api_key_here
   TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
   ```

## Использование

1. Запустите телеграм-бота:
   ```
   python tgbot.py
   ```

2. Найдите своего бота в Telegram по имени пользователя и начните общение

3. Отправьте боту вопрос о еврейских текстах или традициях

## Развертывание с использованием Docker

### Локальное развертывание

1. Соберите Docker-образ:
   ```
   docker build -t shuva-tgbot .
   ```

2. Запустите контейнер:
   ```
   docker run -d --name shuva-bot --env-file .env shuva-tgbot
   ```

   Или с использованием docker-compose:
   ```
   docker-compose up -d
   ```

### Развертывание на Timeweb

1. Подготовьте проект:
   - Убедитесь, что в репозитории есть файлы `Dockerfile`, `.dockerignore` и `docker-compose.yml`
   - Проверьте, что файл `.env` добавлен в `.gitignore` и не будет отправлен в репозиторий

2. Варианты развертывания:

   #### Через Docker Hub
   
   1. Создайте аккаунт на Docker Hub (если еще нет)
   2. Соберите образ локально:
      ```
      docker build -t yourusername/shuva-tgbot:latest .
      ```
   3. Отправьте образ в Docker Hub:
      ```
      docker login
      docker push yourusername/shuva-tgbot:latest
      ```
   4. В панели управления Timeweb:
      - Создайте новый Docker-контейнер
      - Укажите имя образа: `yourusername/shuva-tgbot:latest`
      - Настройте переменные окружения: `OPENROUTER_API_KEY` и `TELEGRAM_BOT_TOKEN`

   #### Через Git-репозиторий
   
   1. В панели управления Timeweb:
      - Создайте новый Docker-контейнер
      - Выберите опцию "Создать из Git-репозитория"
      - Укажите URL вашего репозитория
      - Настройте переменные окружения: `OPENROUTER_API_KEY` и `TELEGRAM_BOT_TOKEN`

3. Настройка контейнера на Timeweb:
   - Выберите подходящий тарифный план
   - Настройте автоматический перезапуск контейнера
   - При необходимости настройте постоянное хранилище для данных

4. Мониторинг и обслуживание:
   - Используйте панель управления Timeweb для просмотра логов
   - Настройте уведомления о состоянии контейнера
   - Регулярно обновляйте образ для получения исправлений безопасности

## Структура проекта

- `tgbot.py` - Основной файл телеграм-бота
- `chatbot.py` - Класс чат-бота, объединяющий функциональность OpenRouter и Sefaria
- `openrouter_api.py` - Модуль для работы с OpenRouter API
- `sefaria_api.py` - Модуль для работы с Sefaria API
- `test_api.py` - Скрипт для тестирования API
- `.env` - Файл с переменными окружения
- `.env.example` - Пример файла с переменными окружения
- `.gitignore` - Файл для исключения из системы контроля версий
- `Dockerfile` - Инструкции для сборки Docker-образа
- `.dockerignore` - Список файлов, исключаемых из Docker-образа
- `docker-compose.yml` - Конфигурация для запуска с использованием docker-compose

## Получение API ключей

### OpenRouter API

Для использования этого бота вам потребуется API ключ от OpenRouter. Чтобы получить ключ:

1. Перейдите на сайт [OpenRouter](https://openrouter.ai/)
2. Зарегистрируйтесь или войдите в свой аккаунт
3. Перейдите в раздел API Keys и создайте новый ключ
4. Скопируйте ключ и добавьте его в файл `.env`

### Telegram Bot API

Для создания телеграм-бота вам потребуется токен от BotFather:

1. Откройте Telegram и найдите @BotFather
2. Отправьте команду `/newbot` и следуйте инструкциям
3. После создания бота вы получите токен
4. Скопируйте токен и добавьте его в файл `.env`

## Устранение неполадок

### Ошибка конфликта при запуске бота

Если при запуске бота вы видите ошибку:
```
telegram.error.Conflict: Conflict: terminated by other getUpdates request; make sure that only one bot instance is running
```

Это означает, что уже запущен другой экземпляр бота с тем же токеном, и они конфликтуют друг с другом. Для решения проблемы:

1. **Проверьте запущенные процессы**:
   - В Windows: откройте Диспетчер задач (Ctrl+Shift+Esc) и найдите процессы Python
   - В Linux/Mac: используйте команду `ps aux | grep python`

2. **Завершите все запущенные экземпляры бота**:
   - В Windows: выберите процесс в Диспетчере задач и нажмите "Завершить задачу"
   - В Linux/Mac: используйте команду `kill <PID>`, где PID - идентификатор процесса

### Проблемы с Docker

1. **Ошибка при сборке образа**:
   - Проверьте, что Dockerfile не содержит ошибок
   - Убедитесь, что все необходимые файлы доступны

2. **Контейнер завершается с ошибкой**:
   - Проверьте логи контейнера: `docker logs shuva-bot`
   - Убедитесь, что переменные окружения настроены правильно

3. **Проблемы с доступом к API**:
   - Проверьте, что ключи API действительны и правильно настроены
   - Убедитесь, что контейнер имеет доступ к интернету

### Другие проблемы

Если у вас возникают другие проблемы при запуске или использовании бота:

1. Убедитесь, что все зависимости установлены корректно:
   ```
   pip install -r requirements.txt
   ```

2. Проверьте, что файл `.env` содержит правильные API ключи

3. Проверьте логи на наличие ошибок и предупреждений

## Примеры запросов

- "Что такое Тора?"
- "Расскажи о празднике Песах"
- "Кто такой Маймонид?"
- "Что говорится в Талмуде о благотворительности?"
- "Объясни концепцию Тиккун Олам"

## Лицензия

MIT

## Благодарности

- [OpenRouter](https://openrouter.ai/) за предоставление доступа к языковым моделям
- [Sefaria](https://www.sefaria.org/) за обширную библиотеку еврейских текстов и открытый API
- [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot) за отличную библиотеку для создания телеграм-ботов
- [Docker](https://www.docker.com/) за инструменты контейнеризации
- [Timeweb](https://timeweb.com/) за хостинг для Docker-контейнеров
